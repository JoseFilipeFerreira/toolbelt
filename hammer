#!/bin/bash
# Deploy dotfiles and install programs that are part of my [workflow](.workflow.csv)
set -e

[[ "$DOTFILES" ]] || DOTFILES="$(dirname "$(readlink -f "$0")")"

_generate_termux_theme(){
    echo -e "\033[32mGenerating termux theme...\033[0m"
    theme_file="$HOME"/.termux/colors.properties
    [[ -e "$theme_file" ]] && echo "Already generated" && return
    touch "$theme_file"
    readarray -t colors < <(\
        grep -E "[a-z]+:\s+'" "$DOTFILES/powertools/alacritty.yml" |
        grep -Ev "(text|cursor)" |
        grep -o '#[0-9a-z]*')

    echo -e "background: #151515\nforeground: ${colors[1]}" >> "$theme_file"

    colors=( "${colors[@]:2}" )
    for i in "${!colors[@]}"; do
        echo "color$i: ${colors[i]}" >> "$theme_file"
    done
}

_make_repos(){
    for repo in "$@"; do
        name="$(basename "$repo")"
        echo -e "\033[32mInstalling $name...\033[0m"
        git clone "$repo" /tmp/"$name"
        sudo make install -C /tmp/"$name"
        rm -rf /tmp/"$name"
    done
}

_get_pkgs(){
    pkg_mngr="$1"
    while IFS=',' read -r l; do
        IFS=',' read -ra args <<< "$l"
        # shellcheck disable=SC2076
        [[ " ${args[*]} " =~ " $pkg_mngr " ]] &&
        {
            [[ ! "${*:2}" ]] ||
            [[ "$(comm -12 \
                <(printf '%s\n' "${@:2}" | sort) \
                <(printf '%s\n' "${args[@]}" | sort))" \
            ]] ;
        } &&
            echo "${args[2]}"
    done < "$DOTFILES/.workflow.csv"
}

_install_pkgs(){
    if command -V pacman &> /dev/null; then
        sudo pacman -Suyy

        readarray -t pkg_pacman < <(_get_pkgs pacman "$@")
        sudo pacman -S --needed "${pkg_pacman[@]}"

        readarray -t pkg_repos < <(_get_pkgs repos "$@")
        _make_repos "${pkg_repos[@]}"

        readarray -t pkg_aura < <(_get_pkgs aur "$@")
        aura -S "${pkg_aura[@]}"
    elif command -V pkg &> /dev/null;then
        pkg update && pkg upgrade
        readarray -t pkg_pkg < <(_get_pkgs pkg "$@")
        pkg install "${pkg_pkg[@]}"
    else
        echo "Package manager not suported"
    fi
}

_setup_home(){
    echo -e "\033[32mCreating home structure...\033[0m"
    mkdir -vp "$HOME/dl"
    mkdir -vp "$HOME/docs"
    mkdir -vp "$HOME/media/pics"
    mkdir -vp "$HOME/media/videos"
    mkdir -vp "$HOME/repos"
}

read -r -p "Type of installation [(F)ULL | (e)ssential | (m)obile]: "
case "$REPLY" in
    FULL|F|"")
        _install_pkgs
        bash "$DOTFILES"/nail essential extra
        _setup_home
        ;;
    essential|e)
        _install_pkgs essential
        bash "$DOTFILES"/nail essential
        _setup_home
        ;;
    mobile|m)
        ! command -V termux-setup-storage &> /dev/null &&
            echo "error: not in a termux env" && exit
        _install_pkgs essential
        bash "$DOTFILES"/nail essential mobile
        [ -d ~/storage ] || termux-setup-storage
        _generate_termux_theme
        termux-reload-settings
        ;;
    *)
        echo "Invalid type of installation"
        exit
        ;;
esac
