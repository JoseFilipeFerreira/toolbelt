#!/bin/bash
# Deploy dotfiles and install programs that are part of my [workflow](.workflow.csv)
# set -e

[[ ! "$DOTFILES" ]] && \
    DOTFILES="$(dirname "$(readlink -f "$0")")"

_global_dark_theme(){
    echo -e "\033[32mInstalling global dark theme...\033[0m"
    [[ -d "$HOME"/.themes/ayu ]] && echo -e "Already installed\n" && return
    wget -P /tmp "https://github.com/Mrcuve0/Aritim-Dark/archive/master.zip"
    unzip -q /tmp/master.zip -d /tmp
    mkdir -p "$HOME"/.themes
    mv /tmp/Aritim-Dark-master/GTK "$HOME"/.themes/ayu
    rm -r /tmp/{Aritim-Dark-master,master.zip}
    echo
}

_make_repos(){
    for repo in "$@"; do
        name="$(basename "$repo")"
        echo -e "\033[32mInstalling $name...\033[0m"
        git clone "$repo" /tmp/"$name"
        sudo make install -C /tmp/"$name"
        rm -rf /tmp/"$name"
        echo
    done
}

_get_pkgs(){
    while IFS=',' read -r l; do
        IFS=',' read -ra args <<< "$l"
        [[ ${args[*]:1} =~ $1 ]] &&
        {
            [[ ! "${*:2}" ]] ||
            [[ "$(comm -12 <(printf '%s\n' "${@:2}" | sort) <(printf '%s\n' "${args[@]}" | sort))" ]] ;
        } &&
            echo -n "${args[0]} "
    done < "$DOTFILES/.workflow.csv"
}

_install_pkgs(){
        sudo pacman -Suyy
        sudo pacman -S --needed  $(_get_pkgs pacman "$@")
        bash nail "$@"
        _make_repos $(_get_pkgs repos "$@")
        aura -S $(_get_pkgs aur "$@")
        # pip install --upgrade pip $(_get_pkgs pip "$@")
}

_create_home(){
    echo -e "\033[32mCreating home structure...\033[0m"
    mkdir -vp "$HOME/dl"
    mkdir -vp "$HOME/docs"
    mkdir -vp "$HOME/media/pics"
    mkdir -vp "$HOME/media/videos"
    mkdir -vp "$HOME/repos"
    echo
}

read -r -p "Type of installation [(F)ULL | (e)ssential]: "
case "$REPLY" in
    FULL|F|"")
        _install_pkgs
        _global_dark_theme
        ;;
    essential|e)
        _install_pkgs essential
        ;;
    *)
        echo "Invalid type of installation"
        exit
        ;;
esac

_create_home
