#!/bin/python3
"""block to display i3 workspaces on thonkbar"""
from os import getlogin
from sys import stdout

from i3ipc import Connection, Event # type: ignore

from watchdog.events import FileSystemEventHandler
from watchdog.observers import Observer

COLORSCHEME_FILE = f"/tmp/{getlogin()}/wall_colors"

I3WM = Connection()

def print_workspaces(color):
    """print workspaces in lemonbar format"""

    workspaces = [None] * 10

    for workspace in I3WM.get_workspaces():
        try:
            name_int = (int(workspace.name)) - 1
            if workspace.urgent:
                workspaces[name_int] = f'%{{F{color.urgent}}}'
            elif workspace.focused:
                workspaces[name_int] = f'%{{F{color.focused}}}'
            else:
                workspaces[name_int] = f'%{{F{color.default}}}'
        except ValueError:
            print("re")

    while workspaces[-1] is None:
        workspaces.pop()

    workspaces = [x if x else f"%{{F{color.default}}}" for x in workspaces]

    print(*workspaces, "%{F-}")
    stdout.flush()


class ColorschemeHandler(FileSystemEventHandler):
    """ Class for managing and updating the colorsheme """
    urgent = "#E6f22c40"
    focused = "#E6407ee7"
    default = "#E6a8a19f"

    def __init__(self):
        self.update_colorscheme()

    def update_colorscheme(self):
        """ update colorsheme from file generated by wall """
        try:
            with open(COLORSCHEME_FILE, "r", encoding="utf-8") as file:
                colors = file.readline().split()
                if len(colors) == 2:
                    self.focused = colors[0]
                    print_workspaces(self)
        except OSError as _:
            pass

    def on_modified(self, _):
        """ update when file is modified """
        self.update_colorscheme()

    def on_created(self, _):
        """ update when file is created """
        self.update_colorscheme()


colorscheme = ColorschemeHandler()

observer = Observer()
observer.schedule(colorscheme, COLORSCHEME_FILE)
observer.start()

def react_on_event(_, __):
    """function to handle events"""
    print_workspaces(colorscheme)

I3WM.on(Event.WORKSPACE_FOCUS, react_on_event)
I3WM.on(Event.WORKSPACE_URGENT, react_on_event)
I3WM.on(Event.WINDOW_MOVE, react_on_event)
I3WM.on(Event.WINDOW_NEW, react_on_event)
I3WM.on(Event.WINDOW_URGENT, react_on_event)

print_workspaces(colorscheme)

I3WM.main()
